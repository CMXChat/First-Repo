<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>CMX • Field Report Generator</title>

<style>
:root{
  --bg:#000; --panel:#0b0c0e; --panel-2:#111317;
  --ink:#e7e9ea; --muted:#8b98a5; --line:#2f3336;
  --accent:#1d9bf0; --ok:#19c37d; --bad:#ff5a5f;
  --r:16px;
  --maxw:940px;
  --fs-xl:clamp(22px,4.8vw,30px);
  --fs-lg:clamp(16px,3.6vw,20px);
  --fs:clamp(14px,3.4vw,16px);
  --fs-sm:clamp(12px,2.8vw,13px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  line-height:1.55;font-size:var(--fs);-webkit-text-size-adjust:100%;
}
.container{max-width:var(--maxw);margin:0 auto;padding:18px}
.top{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  position:sticky;top:0;z-index:20;padding:12px 18px;background:rgba(0,0,0,.7);
  backdrop-filter:blur(8px);border-bottom:1px solid var(--line)
}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
.logo{width:30px;height:30px;border:1px solid var(--line);border-radius:10px;display:grid;place-items:center;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02))}
.logo svg{width:18px;height:18px;fill:var(--accent)}
.title{font-size:var(--fs-lg)}
.chip{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:var(--panel);color:var(--muted);font-size:var(--fs-sm)}

h1{margin:18px 0 8px;font-size:var(--fs-xl)}
h2{margin:18px 0 8px;font-size:var(--fs-lg)}
label{display:block;margin:12px 0 6px;font-weight:800}
input,textarea,select{
  width:100%;padding:12px;border-radius:14px;background:var(--panel);
  border:1px solid var(--line);color:var(--ink);outline:none
}
input::placeholder,textarea::placeholder{color:#6f7a86}
textarea{resize:vertical;min-height:110px}

/* Entities grid: compact height only change requested */
.entities{display:grid;gap:10px}
@media(min-width:760px){.entities{grid-template-columns:1fr 1fr}}
.entities textarea{
  min-height:64px; /* compact */
  max-height:120px;
  line-height:1.4;
}

/* Buttons */
.actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:14px}
.btn{
  all:unset;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
  padding:12px 18px;border-radius:999px;font-weight:900;letter-spacing:.2px;
  border:1px solid var(--accent);
  background:linear-gradient(180deg,rgba(29,155,240,.18),rgba(29,155,240,.06));
}
.btn:active{transform:translateY(1px)}

/* Segmented control */
.seg{display:inline-flex;background:var(--panel);border:1px solid var(--line);border-radius:999px;overflow:hidden}
.seg button{
  all:unset;cursor:pointer;padding:8px 14px;font-weight:800
}
.seg button.active{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));border-left:1px solid var(--line);border-right:1px solid var(--line)}

/* Cards */
.card{border:1px solid var(--line);background:var(--panel-2);border-radius:16px;padding:16px}
.kv{border:1px dashed var(--line);border-radius:12px;padding:12px;margin-top:10px}

/* Preview */
.preview{white-space:pre-wrap;background:#050506;border:1px solid var(--line);padding:12px;border-radius:14px;min-height:180px}

/* Print only preview (original) */
@media print{
  body{background:#fff;color:#000}
  .top,.card.form,.actions-top{display:none!important}
  .container{max-width:100%;padding:0}
  .card.preview-wrap{border:0;background:#fff}
  .preview{border:0}
}
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <div class="logo" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M17.5 3L12.9 9.1 20 21h-3.5l-4.7-7.6L7 21H4l5.7-8.6L4.2 3H7.7l4 6.6L16 3h1.5z"/></svg>
    </div>
    <div class="title">CMX • Field Report Generator</div>
  </div>
  <span class="chip">Session <b id="sid"></b></span>
</div>

<div class="container">

  <div class="card form">
    <h1>Agent Console</h1>
    <div class="kv"><b>Daily message:</b> Save your work now, because if you refresh, it will self-destruct. Download or email your report before you exit, and HQ will review as soon as it lands.</div>

    <label for="title">Title</label>
    <input id="title" placeholder="Harassment cluster mapping, Creator A">

    <label for="agent">Agent</label>
    <input id="agent" placeholder="Agent K">

    <label for="date">Date</label>
    <input id="date" type="date">

    <label for="scope">Scope</label>
    <input id="scope" placeholder="Public sources only, last 60 days, EN + ES">

    <label for="summary">Summary</label>
    <textarea id="summary" placeholder="One paragraph explaining what this report covers and the decision it supports."></textarea>

    <h2>Entities</h2>
    <div class="entities">
      <textarea id="ent_persons" placeholder="- Person, city"></textarea>
      <textarea id="ent_handles" placeholder="- @handle1, @handle2"></textarea>
      <textarea id="ent_emails" placeholder="- name@example.com"></textarea>
      <textarea id="ent_domains" placeholder="- example.com"></textarea>
      <textarea id="ent_ips" placeholder="- 1.2.3.4, ASXXXX"></textarea>
    </div>

    <label for="findings">Findings</label>
    <textarea id="findings" placeholder="- Bullet points with links in brackets if needed"></textarea>

    <label for="actions">Actions</label>
    <textarea id="actions" placeholder="- Contact platform safety with exhibits&#10;- Archive all links, export PDF exhibits"></textarea>

    <label for="notes">Notes</label>
    <textarea id="notes" placeholder="Assumptions, alternate explanations ruled out, caveats."></textarea>

    <div class="actions">
      <button class="btn" id="btnGen">Generate</button>
      <button class="btn" id="btnCopy">Copy (Discord)</button>
      <button class="btn" id="btnTxt">Download .txt</button>
      <button class="btn" id="btnEmail">Email to HQ</button>
      <button class="btn" id="btnPdf">Download PDF</button>
    </div>
  </div>

  <div class="card preview-wrap" style="margin-top:12px">
    <div class="actions-top" style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
      <h2 style="margin:0">Preview</h2>
      <div class="seg" role="tablist" aria-label="Format">
        <button id="modeDiscord" class="active" role="tab" aria-selected="true">Discord</button>
        <button id="modePlain" role="tab" aria-selected="false">Plain</button>
      </div>
    </div>
    <div id="preview" class="preview" aria-live="polite"></div>
  </div>

</div>

<script>
/* session */
document.getElementById('sid').textContent=Math.random().toString(36).slice(2,7);

/* helpers */
const $=id=>document.getElementById(id);
const fields=['title','agent','date','scope','summary','ent_persons','ent_handles','ent_emails','ent_domains','ent_ips','findings','actions','notes'];

function buildReport(mode='discord'){
  const v=Object.fromEntries(fields.map(k=>[k,$(k).value||'']));
  const hdr = mode==='discord' ? '**CMX REPORT**' : 'CMX REPORT';
  const b = s => mode==='discord' ? `**${s}**` : s;

  let entities = [v.ent_persons,v.ent_handles,v.ent_emails,v.ent_domains,v.ent_ips]
    .filter(Boolean).join('\n');

  let rpt = `${hdr}\n` +
    `${b('Title')} ${v.title}\n` +
    `${b('Agent')} ${v.agent}\n` +
    `${b('Date')} ${v.date}\n` +
    `${b('Scope')} ${v.scope}\n\n` +
    `${b('Summary')}\n${v.summary}\n\n` +
    `${b('Entities')}\n${entities}\n\n` +
    `${b('Findings')}\n${v.findings}\n\n` +
    `${b('Actions')}\n${v.actions}\n\n` +
    `${b('Notes')}\n${v.notes}`.trim();

  return rpt;
}

function render(){
  const mode = document.body.dataset.mode || 'discord';
  $('preview').textContent = buildReport(mode);
}

$('btnGen').onclick=render;

/* mode toggle + copy label */
function setMode(m){
  document.body.dataset.mode=m;
  $('modeDiscord').classList.toggle('active', m==='discord');
  $('modePlain').classList.toggle('active', m==='plain');
  $('modeDiscord').setAttribute('aria-selected', m==='discord');
  $('modePlain').setAttribute('aria-selected', m==='plain');
  $('btnCopy').textContent = m==='discord' ? 'Copy (Discord)' : 'Copy (Plain)';
  render();
}
$('modeDiscord').onclick=()=>setMode('discord');
$('modePlain').onclick=()=>setMode('plain');
setMode('discord');

/* copy */
$('btnCopy').onclick=()=>{
  const txt=$('preview').textContent;
  if(!txt.trim()){ render(); }
  navigator.clipboard.writeText($('preview').textContent).then(()=>alert('Report copied'));
};

/* download txt */
$('btnTxt').onclick=()=>{
  render();
  const blob=new Blob([$('preview').textContent],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='cmx_report.txt';
  a.click();
};

/* email */
$('btnEmail').onclick=()=>{
  render();
  const subject=encodeURIComponent('CMX Field Report');
  const body=encodeURIComponent($('preview').textContent);
  window.location.href=`mailto:team@cmxchat.com?subject=${subject}&body=${body}`;
};

/* pdf */
$('btnPdf').onclick=()=>{ 
  render(); 
  if (window.__assemblePdf) { window.__assemblePdf(); }
  window.print(); 
};

/* convenience: Ctrl+Enter generates */
window.addEventListener('keydown',e=>{
  if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ $('btnGen').click(); }
});
</script>

<!-- ===== Polished PDF layer (drop-in) ===== -->
<style>
  /* Screen: keep live UI, hide pdf shell */
  #pdf-report-shell{display:none}
  /* Print: show SEO-styled report, hide everything else */
  @media print{
    body{background:#fff !important;color:#111 !important}
    #pdf-report-shell{display:block !important}
    #pdf-report{max-width:840px;margin:0 auto;padding:28px 22px;font:400 15px/1.65 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#111}
    #pdf-cover{border:2px solid #e5e7eb;border-radius:14px;padding:22px 20px;margin-bottom:18px;background:#f8fafc}
    #pdf-h1{margin:0 0 4px;font-size:28px;line-height:1.2;font-weight:900;color:#0b1220;letter-spacing:.2px}
    #pdf-meta{display:flex;flex-wrap:wrap;gap:10px 14px;color:#374151;font-size:13px}
    #pdf-meta .chip{border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#fff}
    .pdf-section{margin:18px 0 14px}
    .pdf-section h2{margin:0 0 8px;font-size:18px;line-height:1.3;color:#0b1220}
    .pdf-section h3{margin:14px 0 6px;font-size:15px;color:#111}
    .pdf-kv{display:grid;grid-template-columns:180px 1fr;gap:6px 14px;border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff}
    .pdf-kv div.key{color:#374151}
    .pdf-box{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:12px}
    .pdf-list{margin:6px 0 0 18px}
    .pdf-grid{display:grid;gap:10px}
    .pdf-grid.cols-2{grid-template-columns:1fr 1fr}
    .muted{color:#6b7280}
    .mono{font:500 13px/1.6 ui-monospace,Menlo,Consolas,monospace;color:#0b1220;word-break:break-word;white-space:pre-wrap}

    /* Hide the live UI when printing */
    body > *:not(#pdf-report-shell){display:none !important}
  }
</style>

<div id="pdf-report-shell" aria-hidden="true">
  <article id="pdf-report">
    <header id="pdf-cover">
      <h1 id="pdf-h1">Intelligence Report</h1>
      <div id="pdf-meta">
        <span class="chip" id="pdf-case">Title: N/A</span>
        <span class="chip" id="pdf-date">Date: N/A</span>
        <span class="chip" id="pdf-author">Agent: N/A</span>
        <span class="chip" id="pdf-confidence">Scope: N/A</span>
      </div>
    </header>

    <section class="pdf-section" id="pdf-summary-sec">
      <h2>Executive Summary</h2>
      <div class="pdf-box" id="pdf-summary">N/A</div>
    </section>

    <section class="pdf-section" id="pdf-entities-sec">
      <h2>Entities</h2>
      <div class="pdf-grid cols-2">
        <div>
          <h3>People</h3>
          <div class="pdf-box mono" id="pdf-people">N/A</div>
        </div>
        <div>
          <h3>Handles</h3>
          <div class="pdf-box mono" id="pdf-handles">N/A</div>
        </div>
        <div>
          <h3>Emails</h3>
          <div class="pdf-box mono" id="pdf-emails">N/A</div>
        </div>
        <div>
          <h3>Domains</h3>
          <div class="pdf-box mono" id="pdf-domains">N/A</div>
        </div>
        <div>
          <h3>IP / ASN</h3>
          <div class="pdf-box mono" id="pdf-ips">N/A</div>
        </div>
      </div>
    </section>

    <section class="pdf-section" id="pdf-findings-sec">
      <h2>Key Findings</h2>
      <ol class="pdf-list" id="pdf-findings"><li>N/A</li></ol>
    </section>

    <section class="pdf-section" id="pdf-actions-sec">
      <h2>Recommended Actions</h2>
      <div class="pdf-box" id="pdf-actions">N/A</div>
    </section>

    <section class="pdf-section" id="pdf-notes-sec">
      <h2>Notes</h2>
      <div class="pdf-box mono" id="pdf-notes">N/A</div>
    </section>

    <footer class="pdf-section" style="margin-top:22px">
      <div class="muted">© CMX, public sources only, reproducible methods.</div>
    </footer>
  </article>
</div>

<script>
/* Build the polished PDF view from your existing fields, without touching on-screen output */
(function(){
  function val(id){ const el=document.getElementById(id); return el ? (el.value||'').trim() : ''; }
  function set(id,txt){ const el=document.getElementById(id); if(el) el.textContent = (txt&&txt.trim())? txt.trim() : 'N/A'; }
  function bullets(text){
    const lines=(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const items=lines.map(L=> (L.match(/^(\*|-|\d+\.)\s+(.*)$/)? RegExp.$2 : L));
    return items;
  }

  function assemble(){
    set('pdf-h1', val('title') || 'Intelligence Report');
    document.getElementById('pdf-case').textContent = 'Title: ' + (val('title') || 'N/A');
    document.getElementById('pdf-date').textContent = 'Date: ' + (val('date') || new Date().toLocaleDateString());
    document.getElementById('pdf-author').textContent = 'Agent: ' + (val('agent') || 'N/A');
    document.getElementById('pdf-confidence').textContent = 'Scope: ' + (val('scope') || 'N/A');

    set('pdf-summary', val('summary'));
    set('pdf-people',  val('ent_persons'));
    set('pdf-handles', val('ent_handles'));
    set('pdf-emails',  val('ent_emails'));
    set('pdf-domains', val('ent_domains'));
    set('pdf-ips',     val('ent_ips'));

    // findings as proper list
    const ul=document.getElementById('pdf-findings');
    ul.innerHTML='';
    const items=bullets(val('findings'));
    if(items.length){
      items.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
    }else{
      const li=document.createElement('li'); li.textContent='N/A'; ul.appendChild(li);
    }

    set('pdf-actions', val('actions'));
    set('pdf-notes',   val('notes'));
  }

  /* expose for the button */
  window.__assemblePdf = assemble;

  /* call before any print, across browsers */
  if('onbeforeprint' in window){
    window.addEventListener('beforeprint', assemble);
  }
  const mq = window.matchMedia && window.matchMedia('print');
  if(mq && mq.addEventListener){
    mq.addEventListener('change', e => { if(e.matches) assemble(); });
  }
})();
</script>
<!-- ===== /Polished PDF layer ===== -->

</body>
</html>