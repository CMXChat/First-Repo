<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>CMX • Meta Extractor</title>
<meta name="color-scheme" content="dark">
<style>
:root{
  --bg:#000; --panel:#0b0c0e; --panel-2:#111317; --panel-3:#0a0c10;
  --ink:#e7e9ea; --muted:#8b98a5; --line:#2f3336;
  --accent:#1d9bf0; --accent2:#82c8ff; --ok:#19c37d; --bad:#ff5a5f; --warn:#f6c76f; --vio:#b072ff;
  --r:16px; --pad:clamp(12px,2.6vw,22px);
  --fs-xl:clamp(22px,5.6vw,42px);
  --fs-lg:clamp(17px,3.2vw,22px);
  --fs:clamp(14px,3vw,16px);
  --fs-sm:clamp(12px,2.5vw,13.5px);
  --maxw:1260px;
}
*{box-sizing:border-box}
html,body{height:100%;overscroll-behavior:contain}
body{
  margin:0;background:
    radial-gradient(1200px 600px at 20% -10%,rgba(29,155,240,.08),transparent),
    radial-gradient(1200px 600px at 120% 100%,rgba(130,200,255,.06),transparent),
    var(--bg);
  color:var(--ink);
  font:400 var(--fs)/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  -webkit-text-size-adjust:100%;
}
a{color:inherit;text-decoration:none}
kbd{border:1px solid var(--line);border-bottom-color:#1a1d22;background:#0d0f12;border-radius:6px;padding:2px 5px;font-size:11px}
hr{border:none;border-top:1px solid var(--line);margin:14px 0}
.hide{display:none}

/* ===== Topbar ===== */
.topbar{
  position:sticky;top:0;z-index:70;
  display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;
  padding:var(--pad);background:rgba(0,0,0,.72);backdrop-filter:blur(8px);
  border-bottom:1px solid var(--line)
}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px;min-width:0}
.logo{flex:0 0 30px;height:30px;border:1px solid var(--line);border-radius:10px;display:grid;place-items:center;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02))}
.logo svg{width:18px;height:18px;fill:var(--accent)}
.title{font-size:var(--fs-lg);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chip{padding:7px 10px;border:1px solid var(--line);border-radius:999px;background:var(--panel);color:var(--muted);font-size:var(--fs-sm);white-space:nowrap}

/* Controls row */
.controls{grid-column:1/-1;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button.trigger{all:unset;cursor:pointer;padding:8px 14px;border:1px solid var(--line);border-radius:999px;background:var(--panel);font-weight:800}

/* ===== Centered modal (Export / Help) ===== */
.modal-backdrop{
  position:fixed;inset:0;display:none;z-index:1001;
  background:rgba(0,0,0,.55);backdrop-filter:blur(2px);
}
.modal{
  position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
  width:min(760px,92vw); max-height:min(86dvh,760px);
  border:1px solid var(--line);border-radius:16px;background:var(--panel-2);
  box-shadow:0 30px 120px rgba(0,0,0,.65);
  display:none; z-index:1002;
}
.modal.open{display:block}
.modal-backdrop.open{display:block}
.modal header{
  display:flex;align-items:center;justify-content:space-between;gap:8px;
  padding:10px 12px;border-bottom:1px solid var(--line);background:#0b0d12;border-radius:16px 16px 0 0
}
.modal header .title{font-weight:900}
.modal header .close{all:unset;cursor:pointer;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:var(--panel);font-weight:800}
.modal .inner{padding:12px;overflow:auto;max-height:calc(min(86dvh,760px) - 102px)}
.modal .item{display:block;width:100%;text-align:left;padding:14px 16px;border-radius:8px;border:1px solid transparent;cursor:pointer}
.modal .item:hover{border-color:var(--line);background:var(--panel)}
.modal .footer{display:flex;justify-content:flex-end;gap:8px;padding:10px 12px;border-top:1px solid var(--line);background:var(--panel-2);border-radius:0 0 16px 16px}

/* prevent background scroll while modal open */
body.modal-open{overflow:hidden}

/* ===== Container + hero ===== */
.container{max-width:var(--maxw);margin:0 auto;padding:0 var(--pad) calc(var(--pad) + env(safe-area-inset-bottom,0px))}
.hero{padding:calc(var(--pad) + 4px) 0 var(--pad)}
.hero h1{margin:.2rem 0 .35rem;font-size:var(--fs-xl);line-height:1.15}
.sub{color:var(--muted);font-size:var(--fs-sm)}

/* ===== Layout ===== */
.grid{display:grid;gap:clamp(12px,2vw,16px);grid-template-columns:minmax(280px,360px) 1fr}
@media(max-width:1100px){.grid{grid-template-columns:1fr}}

.card{border:1px solid var(--line);background:var(--panel-2);border-radius:16px;padding:16px}
.card h2{margin:.2rem 0 .6rem;font-size:var(--fs-lg)}
label{display:block;margin:10px 0 6px;font-weight:800}
input,textarea,select{
  width:100%;padding:12px 14px;border-radius:14px;background:var(--panel);
  border:1px solid var(--line);color:var(--ink);outline:none;font-size:var(--fs)
}
textarea{resize:vertical;min-height:96px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row>*{flex:1 1 160px}
.btn{
  all:unset;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
  padding:12px 16px;border-radius:999px;font-weight:900;letter-spacing:.2px;
  border:1px solid var(--accent);
  background:linear-gradient(180deg,rgba(29,155,240,.18),rgba(29,155,240,.06));
}
.btn:active{transform:translateY(1px)}
.btn.ghost{background:transparent;border-color:var(--line)}
small.muted{color:var(--muted);font-size:var(--fs-sm)}
kbd.k{margin-left:4px}

/* Dropzone */
.drop{
  border:1px dashed var(--line);border-radius:16px;padding:18px;background:var(--panel);
  display:grid;place-items:center;text-align:center;min-height:120px;color:#cfe9ff
}
.drop.over{outline:2px solid var(--accent)}

/* Results */
.pane{border:1px solid var(--line);border-radius:16px;background:var(--panel-3);overflow:hidden}
.pane .head{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--line);background:#0b0d12;gap:8px;flex-wrap:wrap}
.pane .body{padding:12px}
.tiles{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
.tile{border:1px solid var(--line);border-radius:12px;background:#0e1013;padding:10px;cursor:pointer}
.tile:hover{border-color:#3a3f46}
.kv{display:grid;grid-template-columns:1fr 2fr;gap:6px}
.kv div{padding:6px;border-bottom:1px solid #1a1f25}
.code{background:#0b0d12;border:1px solid var(--line);border-radius:12px;padding:10px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12.5px;line-height:1.5;max-height:40vh}
.meta-row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.badge{padding:5px 8px;border:1px solid var(--line);border-radius:999px;background:#0e1013;font-size:11.5px;color:#cfe9ff}
.link{color:#9fd1ff;text-decoration:underline}

/* Footer dock (mobile helpers) */
.dock{position:sticky;bottom:0;z-index:60;background:rgba(10,12,16,.9);backdrop-filter:blur(10px);border-top:1px solid var(--line);padding:8px calc(var(--pad));display:none}
.dock .row{display:flex;gap:8px}
@media(max-width:960px){.dock{display:block}}
</style>
</head>
<body>
<header class="topbar">
  <div class="brand">
    <div class="logo" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M17.5 3L12.9 9.1 20 21h-3.5l-4.7-7.6L7 21H4l5.7-8.6L4.2 3H7.7l4 6.6L16 3h1.5z"/></svg>
    </div>
    <div class="title">CMX • Meta Extractor</div>
  </div>
  <span class="chip">Session <b id="sid"></b></span>
  <div class="controls">
    <button class="trigger" id="btnExport">Export</button>
    <button class="trigger" id="btnHelp">Help</button>
  </div>
</header>

<!-- Modal -->
<div class="modal-backdrop" id="modalBg" hidden></div>
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Modal" hidden>
  <header>
    <div class="title" id="modalTitle">Export</div>
    <button class="close" id="closeModal" aria-label="Close">✕</button>
  </header>
  <div class="inner" id="modalInner"></div>
  <div class="footer">
    <button class="btn ghost" id="doneModal">Done</button>
  </div>
</div>

<main class="container">
  <section class="hero">
    <h1>Metadata & EXIF Inspector</h1>
    <p class="sub">
      Drop files to analyze <b>(images, audio, video, PDF, HTML, JSON, CSV, text)</b>.
      For images with EXIF GPS, we’ll surface precise <b>latitude/longitude</b> with a map link.
      <br>Tip: Many platforms strip GPS; use originals for location.
    </p>
  </section>

  <section class="grid">
    <aside class="card">
      <h2>Import</h2>
      <div class="drop" id="drop">
        <div>
          <div style="font-weight:900">Drop files here</div>
          <div class="muted" style="margin-top:4px">or</div>
          <div style="margin-top:8px"><button class="btn" id="pick">Choose files</button></div>
          <div style="margin-top:8px"><small class="muted">Max ~200MB per file (browser dependent)</small></div>
        </div>
      </div>
      <input id="fileInput" type="file" multiple class="hide" />
      <hr>
      <h2>Filters</h2>
      <div class="row">
        <select id="typeFilter">
          <option value="">All types</option>
          <option>image</option><option>video</option><option>audio</option>
          <option>pdf</option><option>html</option><option>json</option><option>csv</option><option>text</option>
        </select>
        <input id="search" placeholder="Search filename/meta…">
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn ghost" id="clearAll">Clear all</button>
        <button class="btn" id="copyAll">Copy all JSON</button>
      </div>
      <small class="muted">Hotkeys: <kbd class="k">/</kbd> focus search • <kbd class="k">e</kbd> export • <kbd class="k">?</kbd> help.</small>
    </aside>

    <section class="pane">
      <div class="head">
        <div style="font-weight:900">Results</div>
        <div class="meta-row">
          <span class="badge" id="countBadge">0 files</span>
          <span class="badge" id="filterBadge">all</span>
        </div>
      </div>
      <div class="body">
        <div class="tiles" id="tiles"></div>
        <hr>
        <div class="kv" id="kv"></div>
        <div class="meta-row" id="gpsRow" style="display:none">
          <a id="gpsLink" class="link" target="_blank" rel="noopener">Open location in map</a>
        </div>
        <div class="code" id="jsonView" aria-label="JSON view"></div>
      </div>
    </section>
  </section>
</main>

<nav class="dock" aria-label="Mobile actions">
  <div class="row">
    <button class="btn" id="dockPick">+ Files</button>
    <button class="btn ghost" id="dockExport">Export</button>
  </div>
</nav>

<footer style="text-align:center;color:var(--muted);font-size:var(--fs-sm);padding:12px">© CMX</footer>

<script>
/* ===== Utils ===== */
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
$('#sid').textContent=Math.random().toString(36).slice(2,10).toUpperCase();

function bytes(n){const u=['B','KB','MB','GB']; let i=0; while(n>1024 && i<u.length-1){n/=1024;i++;} return n.toFixed(n<10&&i?1:0)+' '+u[i];}
function ext(fn){const m=/\.([^.]+)$/.exec(fn||''); return (m?m[1]:'').toLowerCase(); }
function mimeGroup(m){ if(!m) return ''; const g=m.split('/')[0]; if(g==='application'){ if(/pdf/.test(m)) return 'pdf'; } return g; }
function setText(el,html){el.innerHTML=html;}

/* ===== Modal ===== */
const modal=$('#modal'), modalBg=$('#modalBg'), modalInner=$('#modalInner'), modalTitle=$('#modalTitle');
function openModal(title,contentHTML){
  modalTitle.textContent=title; modalInner.innerHTML=contentHTML;
  document.body.classList.add('modal-open'); modal.hidden=false; modalBg.hidden=false;
  modal.classList.add('open'); modalBg.classList.add('open');
}
function closeModal(){
  document.body.classList.remove('modal-open'); modal.classList.remove('open'); modalBg.classList.remove('open');
  modal.hidden=true; modalBg.hidden=true;
}
$('#closeModal').onclick=closeModal; $('#doneModal').onclick=closeModal; modalBg.onclick=closeModal;

/* ===== Store & UI ===== */
let items=[]; // {id, file, meta:{}}
let selectedId=null;

const tiles=$('#tiles'), jsonView=$('#jsonView'), kv=$('#kv'), gpsRow=$('#gpsRow'), gpsLink=$('#gpsLink');
const typeFilter=$('#typeFilter'), search=$('#search'), countBadge=$('#countBadge'), filterBadge=$('#filterBadge');

function renderTiles(){
  const q=(search.value||'').toLowerCase().trim();
  const t=(typeFilter.value||'').toLowerCase();
  filterBadge.textContent=t||'all';

  const list=items.filter(it=>{
    const hay=[it.file.name, JSON.stringify(it.meta)].join(' ').toLowerCase();
    const passQ = q? hay.includes(q) : true;
    const passT = t? (it.type===t) : true;
    return passQ && passT;
  });

  countBadge.textContent= list.length + ' file' + (list.length===1?'':'s');

  tiles.innerHTML = list.map(it=>{
    const m=it.meta||{};
    const line1 = m.ImageWidth && m.ImageHeight ? `${m.ImageWidth}×${m.ImageHeight}` :
                  m.duration ? `⏱ ${m.duration.toFixed(2)}s` :
                  m.pages ? `${m.pages} pages` : (m.type || it.file.type || '—');
    const badge = it.type || mimeGroup(it.file.type)|| ext(it.file.name);
    return `<div class="tile" data-id="${it.id}">
      <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${it.file.name}</div>
      <div class="muted" style="font-size:12.5px">${bytes(it.file.size)} • ${badge}</div>
      <div class="muted" style="margin-top:6px;font-size:12.5px">${line1}</div>
    </div>`;
  }).join('');

  $$('#tiles .tile').forEach(t=>{
    t.onclick=()=>{ select(t.getAttribute('data-id')); };
  });

  // keep selection if still visible
  if(selectedId && !list.find(x=>x.id===selectedId)) { selectedId=null; }
  if(!selectedId && list[0]) select(list[0].id); else updateDetail();
}

function select(id){ selectedId=id; updateDetail(); }
function updateDetail(){
  const it=items.find(x=>x.id===selectedId);
  kv.innerHTML=''; jsonView.textContent=''; gpsRow.style.display='none';
  if(!it) return;
  const m=it.meta||{};
  // KV table
  const rows = [
    ['Name', it.file.name],
    ['Size', bytes(it.file.size)],
    ['Type', it.file.type || m.type || '—'],
    ['Modified', new Date(it.file.lastModified).toLocaleString()],
  ];

  // Common image fields
  if(m.ImageWidth && m.ImageHeight) rows.push(['Dimensions', `${m.ImageWidth}×${m.ImageHeight}`]);
  if(m.Make) rows.push(['Camera Make', m.Make]);
  if(m.Model) rows.push(['Camera Model', m.Model]);
  if(m.DateTimeOriginal) rows.push(['Original Time', m.DateTimeOriginal]);
  if(m.Orientation) rows.push(['Orientation', m.Orientation]);

  // GPS
  if(typeof m.GPSLatitude==='number' && typeof m.GPSLongitude==='number'){
    rows.push(['Latitude', m.GPSLatitude], ['Longitude', m.GPSLongitude]);
    gpsRow.style.display='flex';
    const lat=m.GPSLatitude, lon=m.GPSLongitude;
    gpsLink.href=`https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=16/${lat}/${lon}`;
    gpsLink.textContent=`Open location (${lat.toFixed(6)}, ${lon.toFixed(6)})`;
  }

  // Media
  if(m.duration) rows.push(['Duration', m.duration.toFixed(3)+' s']);
  if(m.videoWidth && m.videoHeight) rows.push(['Video Size', `${m.videoWidth}×${m.videoHeight}`]);

  // PDF / Doc
  if(m.Title) rows.push(['Title', m.Title]);
  if(m.Author) rows.push(['Author', m.Author]);
  if(m.Creator) rows.push(['Creator', m.Creator]);
  if(m.Producer) rows.push(['Producer', m.Producer]);
  if(m.CreationDate) rows.push(['Created', m.CreationDate]);
  if(m.ModDate) rows.push(['Modified', m.ModDate]);

  // Build KV
  kv.innerHTML = rows.map(([k,v])=>`<div class="muted">${k}</div><div>${escapeHtml(String(v))}</div>`).join('');

  // JSON view
  jsonView.textContent = JSON.stringify(m, null, 2);
}

function escapeHtml(s){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));}

/* ===== Import handling ===== */
const drop=$('#drop'), fileInput=$('#fileInput');
$('#pick').onclick=()=>fileInput.click(); $('#dockPick').onclick=()=>fileInput.click();
['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); e.dataTransfer.dropEffect='copy'; drop.classList.add('over'); }));
['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('over'); }));
drop.addEventListener('drop',e=> handleFiles(e.dataTransfer.files));
fileInput.addEventListener('change',e=> handleFiles(e.target.files));

async function handleFiles(fileList){
  const arr=[...fileList];
  for(const file of arr){
    const id=Math.random().toString(36).slice(2,10);
    const base={id,file, meta:{name:file.name, size:file.size, type:file.type, lastModified:file.lastModified}};
    const type = detectType(file);
    base.type=type;
    try{
      base.meta = {...base.meta, ...(await extractMeta(file,type))};
    }catch(err){
      base.meta.error=String(err);
    }
    items.push(base);
  }
  renderTiles();
}

function detectType(file){
  const m=file.type||'';
  const e=ext(file.name);
  if(m.startsWith('image/')) return 'image';
  if(m.startsWith('video/')) return 'video';
  if(m.startsWith('audio/')) return 'audio';
  if(m==='application/pdf' || e==='pdf') return 'pdf';
  if(m==='text/html' || e==='html' || e==='htm') return 'html';
  if(m==='application/json' || e==='json') return 'json';
  if(e==='yaml' || e==='yml') return 'text';
  if(e==='toml' || e==='csv' || m.startsWith('text/')) return 'text';
  return '';
}

/* ===== Extraction pipeline ===== */
async function extractMeta(file,type){
  const buf = await file.arrayBuffer().catch(()=>null);
  const meta = { type: file.type };

  if(type==='image'){
    // Dimensions via Image bitmap
    try{
      const img = await createImageBitmap(file);
      meta.ImageWidth = img.width; meta.ImageHeight = img.height;
    }catch{}
    // EXIF (best-effort)
    if(buf) try{ Object.assign(meta, parseEXIF(new DataView(buf))); }catch(e){ meta.exifError=String(e); }
  }
  else if(type==='video' || type==='audio'){
    meta.kind=type;
    meta.duration = await readMediaDuration(file, type);
    if(type==='video'){
      const vinfo = await readVideoSize(file);
      Object.assign(meta, vinfo);
    }
  }
  else if(type==='pdf' && buf){
    Object.assign(meta, scanPDFForInfo(new Uint8Array(buf)));
  }
  else if(type==='html' && buf){
    try{
      const txt = new TextDecoder(getLikelyEncoding(new Uint8Array(buf))).decode(new Uint8Array(buf).slice(0, 512*1024));
      Object.assign(meta, scanHTML(txt));
    }catch(e){ meta.htmlError=String(e); }
  }
  else if(type==='json' && buf){
    try{
      const txt=new TextDecoder().decode(buf);
      meta.json=JSON.parse(txt);
      meta.summary = Array.isArray(meta.json) ? `Array(${meta.json.length})` : `Object(${Object.keys(meta.json).length} keys)`;
    }catch(e){ meta.jsonError=String(e); }
  }
  else if(type==='text' && buf){
    const raw=new Uint8Array(buf);
    const enc=getLikelyEncoding(raw);
    const txt=new TextDecoder(enc).decode(raw);
    meta.preview = txt.slice(0, 4000);
    meta.lines = (txt.match(/\n/g)||[]).length+1;
    if(/,/.test(txt) && /\n/.test(txt)) meta.guess='CSV or delimited text';
    if(/^-{3}\n/.test(txt)) meta.guess='YAML/TOML front-matter or config';
  }

  return meta;
}

/* ===== HTML detection helpers ===== */
function scanHTML(txt){
  const out={};
  const title = /<title[^>]*>([\s\S]*?)<\/title>/i.exec(txt);
  if(title) out.Title = title[1].trim();
  const metas=[...txt.matchAll(/<meta\s+[^>]*>/gi)];
  const metaObj={};
  metas.forEach(m=>{
    const name = /\bname=["']?([^"'>\s]+)/i.exec(m[0])?.[1] || /\bproperty=["']?([^"'>\s]+)/i.exec(m[0])?.[1];
    const content = /\bcontent=["']?([^"']*)/i.exec(m[0])?.[1];
    if(name) metaObj[name]=content||'';
  });
  if(Object.keys(metaObj).length) out.meta = metaObj;
  return out;
}

/* ===== Media readers ===== */
function readMediaDuration(file, kind){
  return new Promise(res=>{
    const el = document.createElement(kind==='video' ? 'video' : 'audio');
    el.preload='metadata';
    el.src=URL.createObjectURL(file);
    el.onloadedmetadata=()=>{res(isFinite(el.duration)?el.duration:NaN); URL.revokeObjectURL(el.src);};
    el.onerror=()=>{res(NaN); try{URL.revokeObjectURL(el.src);}catch{}};
  });
}
function readVideoSize(file){
  return new Promise(res=>{
    const v=document.createElement('video'); v.preload='metadata'; v.src=URL.createObjectURL(file);
    v.onloadedmetadata=()=>{res({videoWidth:v.videoWidth, videoHeight:v.videoHeight}); URL.revokeObjectURL(v.src);};
    v.onerror=()=>{res({}); try{URL.revokeObjectURL(v.src);}catch{}};
  });
}

/* ===== PDF quick scan ===== */
function scanPDFForInfo(bytes){
  // naive scan of first & last chunks for /Info entries (best-effort)
  const text = u8sliceToString(bytes, 0, Math.min(bytes.length, 1024*256)) +
               u8sliceToString(bytes, Math.max(0, bytes.length-1024*256), bytes.length);
  const out={};
  const grab = (k)=> {
    const m=new RegExp('/'+k+'\\s*\\(([^\\)]*)\\)').exec(text);
    return m?m[1]:undefined;
  };
  out.Title=grab('Title'); out.Author=grab('Author'); out.Creator=grab('Creator');
  out.Producer=grab('Producer'); out.CreationDate=grab('CreationDate'); out.ModDate=grab('ModDate');
  return out;
}
function u8sliceToString(u8, start, end){ return new TextDecoder().decode(u8.slice(start,end)); }

/* ===== Encoding guess (very light) ===== */
function getLikelyEncoding(u8){
  // If it has a UTF-8 BOM
  if(u8[0]===0xEF && u8[1]===0xBB && u8[2]===0xBF) return 'utf-8';
  // assume utf-8 as default
  return 'utf-8';
}

/* ===== EXIF parser (compact, common tags + GPS) ===== */
function parseEXIF(view){
  // Find APP1 Exif marker
  // JPEG starts with 0xFFD8 ... we scan segments for 0xFFE1 (APP1)
  let offset=0;
  if(view.getUint16(0)!==0xFFD8) throw 'Not a JPEG or no SOI';
  offset=2;
  while(offset < view.byteLength){
    if(view.getUint8(offset)!==0xFF) break;
    const marker=view.getUint8(offset+1);
    const size=view.getUint16(offset+2);
    if(marker===0xE1){ // APP1
      // Check “Exif\0\0”
      if(view.getUint32(offset+4)!==0x45786966 || view.getUint16(offset+8)!==0) break;
      const tiffOffset = offset+10;
      return readTIFF(view, tiffOffset);
    }else{
      offset += 2 + size;
    }
  }
  return {}; // no EXIF
}

function readTIFF(view, tiff){
  const byteOrder=view.getUint16(tiff);
  const isLE = byteOrder===0x4949; // "II"
  if(!isLE && byteOrder!==0x4D4D) throw 'Bad byte order';
  const getU16=(o)=> view.getUint16(o, isLE);
  const getU32=(o)=> view.getUint32(o, isLE);

  const magic=getU16(tiff+2); if(magic!==0x002A) throw 'Bad TIFF magic';
  const ifd0Offset=getU32(tiff+4)+tiff;
  const tags={};

  readIFD(view, tiff, ifd0Offset, tags);

  // EXIF SubIFD pointer
  const exifIFD = tags[0x8769]; if(typeof exifIFD==='number') readIFD(view, tiff, exifIFD+tiff, tags);
  // GPS IFD pointer
  const gpsIFD = tags[0x8825]; if(typeof gpsIFD==='number'){
    const gpsTags={}; readIFD(view, tiff, gpsIFD+tiff, gpsTags);
    // Convert GPS to decimal
    const lat = gpsToDecimal(gpsTags[0x0002], gpsTags[0x0001]);
    const lon = gpsToDecimal(gpsTags[0x0004], gpsTags[0x0003]);
    if(lat!=null && lon!=null){ tags.GPSLatitude=lat; tags.GPSLongitude=lon; }
  }

  // Map common tags to human names
  const out={};
  if(tags[0x010F]) out.Make=tags[0x010F];
  if(tags[0x0110]) out.Model=tags[0x0110];
  if(tags[0x0132]) out.DateTime=tags[0x0132];
  if(tags[0x9003]) out.DateTimeOriginal=tags[0x9003];
  if(tags[0x0112]) out.Orientation=tags[0x0112];
  if(tags[0xA002]) out.ImageWidth=tags[0xA002];
  if(tags[0xA003]) out.ImageHeight=tags[0xA003];
  if(tags.GPSLatitude!=null) out.GPSLatitude=tags.GPSLatitude;
  if(tags.GPSLongitude!=null) out.GPSLongitude=tags.GPSLongitude;

  return out;

  function readIFD(view, tiff, offset, into){
    const entries = getU16(offset);
    for(let i=0;i<entries;i++){
      const p = offset+2 + i*12;
      const tag = getU16(p);
      const type = getU16(p+2);
      const count = getU32(p+4);
      const valOff = p+8;
      const valPtr = (count*typeSize(type) > 4) ? (tiff + getU32(valOff)) : valOff;

      let val = readValue(type, count, valPtr);
      into[tag]=val;
    }
  }
  function typeSize(t){ return ({1:1,2:1,3:2,4:4,5:8,7:1,9:4,10:8}[t]||0); }
  function readValue(type,count,ptr){
    switch(type){
      case 1: // BYTE
      case 7: // UNDEFINED
        if(count===1) return view.getUint8(ptr);
        return [...Array(count)].map((_,i)=>view.getUint8(ptr+i));
      case 2: { // ASCII
        let s=''; for(let i=0;i<count-1;i++) s+=String.fromCharCode(view.getUint8(ptr+i));
        return s;
      }
      case 3: // SHORT
        if(count===1) return getU16(ptr);
        return [...Array(count)].map((_,i)=>getU16(ptr+2*i));
      case 4: // LONG
        if(count===1) return getU32(ptr);
        return [...Array(count)].map((_,i)=>getU32(ptr+4*i));
      case 5: // RATIONAL
        if(count===1) return getU32(ptr)/getU32(ptr+4);
        return [...Array(count)].map((_,i)=>{ const a=ptr+i*8; return getU32(a)/getU32(a+4); });
      case 9: // SLONG
        if(count===1) return view.getInt32(ptr, isLE);
        return [...Array(count)].map((_,i)=>view.getInt32(ptr+4*i, isLE));
      case 10: // SRATIONAL
        if(count===1) return view.getInt32(ptr, isLE)/view.getInt32(ptr+4, isLE);
        return [...Array(count)].map((_,i)=>{ const a=ptr+i*8; return view.getInt32(a, isLE)/view.getInt32(a+4, isLE); });
      default: return null;
    }
  }
  function gpsToDecimal(ratArr, ref){
    if(!ratArr || !ref) return null;
    const [deg, min, sec] = Array.isArray(ratArr)?ratArr:[ratArr,0,0];
    const sign = (String(ref).toUpperCase()==='S' || String(ref).toUpperCase()==='W') ? -1 : 1;
    const val = sign * (deg + (min||0)/60 + (sec||0)/3600);
    return isFinite(val)?val:null;
  }
}

/* ===== Export / Help ===== */
function exportAll(){
  const data = items.map(i=>({
    file:{name:i.file.name,size:i.file.size,type:i.file.type,lastModified:i.file.lastModified},
    type:i.type, meta:i.meta
  }));
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const html = `
    <p>Download your extracted metadata as JSON.</p>
    <button class="item" id="dl">Download JSON</button>
    <hr>
    <p class="muted">Tip: keep original files if you need deeper extraction (e.g., DOCX internal props, ID3 frames). Client-side extraction is limited to data present in the file and supported by the browser.</p>
  `;
  openModal('Export', html);
  $('#dl').onclick=()=>{ const a=document.createElement('a'); a.href=url; a.download='cmx-meta-export.json'; a.click(); };
}
function help(){
  const html = `
    <div class="kv">
      <div class="muted">Images</div><div>Dimensions + EXIF (Date/Time, Make/Model, Orientation, GPS if present)</div>
      <div class="muted">Audio/Video</div><div>Duration; video dimensions via browser metadata</div>
      <div class="muted">PDF</div><div>Best-effort scan of /Title, /Author, /Creator, /Producer, /CreationDate, /ModDate</div>
      <div class="muted">HTML</div><div>&lt;title&gt; and &lt;meta name="..."&gt; from local files</div>
      <div class="muted">JSON/Text</div><div>Type detection + summary/preview</div>
      <div class="muted">Location</div><div>Shown when the image actually contains GPS EXIF. Many apps strip it.</div>
      <div class="muted">Privacy</div><div>Everything runs locally in your browser—no uploads.</div>
    </div>
  `;
  openModal('Help', html);
}
$('#btnExport').onclick=exportAll; $('#dockExport').onclick=exportAll;
$('#btnHelp').onclick=help;
document.addEventListener('keydown',e=>{
  if(e.key==='/'){ e.preventDefault(); $('#search').focus(); }
  if(e.key.toLowerCase()==='e'){ exportAll(); }
  if(e.key==='?'){ help(); }
  if(e.key==='Escape'){ closeModal(); }
});

/* ===== Controls ===== */
typeFilter.onchange=renderTiles;
search.oninput=renderTiles;
$('#clearAll').onclick=()=>{ items=[]; selectedId=null; renderTiles(); };
$('#copyAll').onclick=async ()=>{
  try{
    const data = items.map(i=>({file:{name:i.file.name,size:i.file.size,type:i.file.type,lastModified:i.file.lastModified},type:i.type,meta:i.meta}));
    await navigator.clipboard.writeText(JSON.stringify(data,null,2));
    toast('Copied JSON');
  }catch{ toast('Copy failed'); }
};

/* ===== Toast (quick) ===== */
function toast(msg){
  const t=document.createElement('div');
  t.textContent=msg;
  t.style.position='fixed'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.bottom='16px';
  t.style.background='#0b0d12'; t.style.border='1px solid var(--line)'; t.style.borderRadius='12px';
  t.style.padding='8px 12px'; t.style.fontSize='12.5px'; t.style.color='#cfe9ff'; t.style.zIndex='9999';
  document.body.appendChild(t); setTimeout(()=>t.remove(), 1600);
}

/* ===== Kickoff ===== */
renderTiles();
</script>
</body>
</html>